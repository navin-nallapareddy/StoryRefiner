<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StoryRefiner</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    :root {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --container-bg-color: #ffffff;
      --button-bg-color: #2563eb;
      --button-hover-color: #1d4ed8;
      --header-gradient-start: #3b82f6;
      --header-gradient-end: #9333ea;
      --result-bg-color: #f0f0f0;
      --result-border-color: #ddd;
      --result-table-th-bg: #2563eb;
      --link-bg-color: #ffdd00;
      --link-text-color: #000;
    }

    /* Ocean Breeze theme */
    .theme-ocean {
      --bg-color: #e0f7fa;
      --text-color: #006064;
      --container-bg-color: #ffffff;
      --button-bg-color: #00acc1;
      --button-hover-color: #00838f;
      --header-gradient-start: #00acc1;
      --header-gradient-end: #004d40;
      --result-bg-color: #b2ebf2;
      --result-border-color: #4dd0e1;
      --result-table-th-bg: #00acc1;
    }

    /* Earth Tones theme */
    .theme-earth {
      --bg-color: #f7f4e9;
      --text-color: #7b4b3a;
      --container-bg-color: #ffffff;
      --button-bg-color: #c19a6b;
      --button-hover-color: #966d4f;
      --header-gradient-start: #c19a6b;
      --header-gradient-end: #7b4b3a;
      --result-bg-color: #f0eae2;
      --result-border-color: #d6c7b7;
      --result-table-th-bg: #c19a6b;
    }

    /* Midnight theme */
    .theme-midnight {
      --bg-color: #1a1a2e;
      --text-color: #e0e0e0;
      --container-bg-color: #16213e;
      --button-bg-color: #0f3460;
      --button-hover-color: #e94560;
      --header-gradient-start: #0f3460;
      --header-gradient-end: #e94560;
      --result-bg-color: #212c45;
      --result-border-color: #33415c;
      --result-table-th-bg: #0f3460;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: var(--container-bg-color);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    textarea, input {
      width: 100%;
      padding: 10px;
      margin: 0 0 10px 0;
      font-size: 1rem;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 1rem;
      background-color: var(--button-bg-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: var(--button-hover-color);
    }
    #result {
      margin-top: 20px;
      padding: 10px;
      background: var(--result-bg-color);
      border: 1px solid var(--result-border-color);
      border-radius: 5px;
      white-space: pre-wrap;
    }
    #result table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ccc;
    }
    #result th,
    #result td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    #result th {
      background-color: var(--result-table-th-bg);
      color: white;
    }
    .spinner {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      position: relative;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-left-color: #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
      font-size: 12px;
    }
    .spinner span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  
  <div style="position: absolute; top: 20px; left: 30px;">
    <img src="Navin.jpeg" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.2);" / style="width: 80px; height: 80px; border-radius: 50%;" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 8px rgba(0,0,0,0.2);">
</div>
  
  <div style="position: absolute; top: 30px; right: 30px;">
    <a href="https://coff.ee/9cz644dq57s" target="_blank" style="
        text-decoration: none;
        background-color: var(--link-bg-color);
        color: var(--link-text-color);
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 600;
        font-family: 'Segoe UI', sans-serif;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
        â˜• Buy Me a Coffee
    </a>
    <select id="themeSelector" style="margin-left:10px; padding:6px; border-radius:6px;">
      <option value="ocean">Ocean Breeze</option>
      <option value="earth">Earth Tones</option>
      <option value="midnight">Midnight</option>
    </select>
  </div>
  
  <div class="container">
    <h1 style="
    font-size: 2.5rem;
    font-weight: 800;
    text-align: center;
    background: linear-gradient(to right, var(--header-gradient-start), var(--header-gradient-end));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 2rem;">AI User Story Refiner</h1>

    <h3>User Story</h3>
    <textarea id="userStory" rows="4" placeholder="User Story"></textarea>
    <h3>Assumptions</h3>
    <textarea id="assumptions" rows="4" placeholder="Assumptions"></textarea>
    <h3>Acceptance Criteria</h3>
    <textarea id="acceptanceCriteria" rows="4" placeholder="Acceptance Criteria"></textarea>
    <button onclick="callOpenAI('rate')">Rate It</button>
    <button onclick="callOpenAI('rewrite')">Re-write</button>
    <button onclick="callOpenAI('summary')">Test &amp; Risk Summary</button>
    <button onclick="callOpenAI('scripts')" id="scriptsBtn">Generate Test Scripts</button>
    <button id="exportBtn" style="display:none;" onclick="exportToCsv()">Export to Excel</button>
    <div id="loader" style="display:none;" class="spinner"><span id="timer">0</span></div>
    <div id="result"></div>
  </div>

  <script>
    function applyTheme(name) {
      document.body.classList.remove('theme-ocean', 'theme-earth', 'theme-midnight');
      document.body.classList.add('theme-' + name);
    }

    let timerId;
    let startTime;
    let summaryScenarios = [];

    document.addEventListener('DOMContentLoaded', () => {
      const selector = document.getElementById('themeSelector');
      const saved = localStorage.getItem('theme') || 'ocean';
      applyTheme(saved);
      selector.value = saved;
      selector.addEventListener('change', () => {
        applyTheme(selector.value);
        localStorage.setItem('theme', selector.value);
      });
    });

    async function callOpenAI(type) {
      const loader = document.getElementById('loader');
      const timer = document.getElementById('timer');
      loader.style.display = 'inline-flex';
      timer.textContent = '0';
      startTime = Date.now();
      timerId = setInterval(() => {
        const secs = Math.floor((Date.now() - startTime) / 1000);
        timer.textContent = secs.toString();
      }, 1000);
      document.getElementById('result').innerHTML = '';

      const userStory = document.getElementById('userStory').value;
      const assumptions = document.getElementById('assumptions').value;
      const acceptanceCriteria = document.getElementById('acceptanceCriteria').value;

      let prompt = '';
      if (type === 'rate') {
        prompt = `Please rate the following user story based on the following criteria:\n\n- Clarity\n- Feasibility\n- Testability\n- Completeness\n- Value\n\nReturn the results as HTML <tr> rows only, like this:\n<tr><td>Clarity</td><td>8/10</td><td>Clear but missing outcome detail</td></tr>\n...\n\nUser Story: ${userStory}\nAssumptions: ${assumptions}\nAcceptance Criteria: ${acceptanceCriteria}`;
      } else if (type === 'rewrite') {
        prompt = `Please rewrite the following user story in proper format.\n\n1. Use the format: 'As a [user], I want to [goal] so that [reason]'.\n2. List assumptions clearly.\n3. Provide well-defined, bullet-point acceptance criteria.\n4. Describe a brief test approach that covers the user story.\n\nUser Story: ${userStory}\nAssumptions: ${assumptions}\nAcceptance Criteria: ${acceptanceCriteria}`;
      } else if (type === 'scripts') {
        let scenarioText = '';
        if (summaryScenarios.length) {
          scenarioText =
            '\n\nTest Scenarios:\n' +
            summaryScenarios.map((s, i) => `${i + 1}. ${s}`).join('\n');
        }
          prompt = `You are a senior test analyst. Be extremely thorough and analytical.${scenarioText}\n\nUse the following inputs provided by the user:\n\nUser Story:\n${userStory}\n\nAssumptions:\n${assumptions}\n\nAcceptance Criteria:\n${acceptanceCriteria}\n\nYour tasks:\n\n1. Carefully analyze this information and generate detailed test steps for each provided scenario. Each scenario must contain at least three steps and each test case must have its step numbering start at 1.\n\n2. Return the data as a structured JSON array of rows, where each row represents a single test step. Each row must include these exact fields:\n- id: leave this blank (Azure DevOps assigns it automatically)\n- work_item_type: always set to "Test Case"\n- title: the test case title (repeated on every row of that test case)\n- test_step: the step number, starting from 1 for each new test case\n- step_action: what the user does\n- step_expected: what is expected to happen\n\nImportant formatting requirements:\n- Each new test case must restart its test_step at 1.\n- Repeat the fields id, work_item_type, and title for every step of the same test case, as Azure DevOps needs this to group the steps under each test case.\n- Ensure every assumption and acceptance criterion is fully tested, and include any implied scenarios a professional senior QA would identify.\n\nOutput only the JSON array of rows, with no extra commentary or explanation. Format it cleanly for easy parsing.`;
      } else {
        prompt = `Summarize recommended test cases for the following user story. Provide a table using the columns ID, Test Description and Risk Level. Return only HTML <tr> rows.\n\nUser Story: ${userStory}\nAssumptions: ${assumptions}\nAcceptance Criteria: ${acceptanceCriteria}`;
      }

      try {
        const response = await fetch('/api/openai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API error (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        if (type === 'rate') {
          document.getElementById('result').innerHTML =
            '<table><tr><th>Criteria</th><th>Rating</th><th>Comments</th></tr>' +
            data.result +
            '</table>';
          document.getElementById('exportBtn').style.display = 'none';
        } else if (type === 'rewrite') {
          document.getElementById('result').innerText = data.result;
          document.getElementById('exportBtn').style.display = 'none';
        } else if (type === 'scripts') {
          const rows = JSON.parse(data.result);
          let html = '<table><tr><th>ID</th><th>Work Item Type</th><th>Title</th><th>Step #</th><th>Action</th><th>Expected</th></tr>';
          rows.forEach(r => {
            html += `<tr><td>${r.id}</td><td>${r.work_item_type}</td><td>${r.title}</td><td>${r.test_step}</td><td>${r.step_action}</td><td>${r.step_expected}</td></tr>`;
          });
          html += '</table>';
          document.getElementById('result').innerHTML = html;
          document.getElementById('exportBtn').style.display = 'inline-block';
          exportToCsv();
          document.getElementById('exportBtn').style.display = 'none';
        } else {
          document.getElementById('result').innerHTML =
            '<table><tr><th>ID</th><th>Test Description</th><th>Risk Level</th></tr>' +
            data.result +
            '</table>';
          const tmp = document.createElement('div');
          tmp.innerHTML = '<table>' + data.result + '</table>';
          summaryScenarios = Array.from(tmp.querySelectorAll('tr'))
            .slice(1)
            .map(row => row.children[1]?.textContent.trim())
            .filter(Boolean);
          document.getElementById('exportBtn').style.display = 'none';
        }

        const payload = {
          action:
            type === 'rate'
              ? 'RATE'
              : type === 'rewrite'
              ? 'REWRITE'
              : type === 'scripts'
              ? 'SCRIPTS'
              : 'SUMMARY',
          original_story: userStory,
          original_assumptions: assumptions,
          original_criteria: acceptanceCriteria,
          raw_response: data.raw
        };

        if (type === 'rate') {
          payload.ratings = data.result;
        } else if (type === 'rewrite') {
          payload.rewritten_story = data.result;
        } else {
          payload.rewritten_story = data.result;
        }

        try {
          const insertResp = await fetch('/user-story', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!insertResp.ok) {
            const errorText = await insertResp.text();
            console.error('Insert error:', errorText);
          }
        } catch (err) {
          console.error('Insert error:', err);
        }
      } catch (error) {
        console.error('Error response:', error);
        document.getElementById('result').innerHTML = '<div style="color:red">Error: ' + error.message + '</div>';
      } finally {
        document.getElementById('loader').style.display = 'none';
        clearInterval(timerId);
        document.getElementById('timer').textContent = '0';
      }
    }

    function exportToCsv() {
      const table = document.querySelector('#result table');
      if (!table) return;
      const rows = Array.from(table.querySelectorAll('tr'));
      const csv = rows
        .map(row =>
          Array.from(row.querySelectorAll('th,td'))
            .map(cell => '"' + cell.innerText.replace(/"/g, '""') + '"')
            .join(',')
        )
        .join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'test-scripts.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
